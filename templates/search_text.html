{% extends "layout.html" %}

{% block title %}T√¨m ki·∫øm theo t·ª´ kh√≥a - Orchard{% endblock %}

{% block content %}
<style>
  .search-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .search-header h2 {
    font-size: 2rem;
    color: var(--text);
    margin-bottom: 10px;
  }

  .search-header p {
    color: var(--text-light);
  }

  .search-box {
    background: var(--bg);
    border-radius: 25px;
    padding: 30px;
    box-shadow: 
      10px 10px 25px var(--shadow-dark),
      -10px -10px 25px var(--shadow-light);
    margin-bottom: 40px;
  }

  .search-main {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
  }

  .search-input-wrapper {
    flex: 1;
    display: flex;
    gap: 10px;
  }

  .search-input-wrapper input {
    flex: 1;
  }

  .voice-btn {
    width: 50px;
    height: 50px;
    border-radius: 15px;
    background: linear-gradient(145deg, #ff7043, #e64a19);
    border: none;
    color: white;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 
      4px 4px 10px var(--shadow-dark),
      -4px -4px 10px var(--shadow-light);
    transition: all 0.3s ease;
  }

  .voice-btn:hover {
    transform: scale(1.05);
  }

  .voice-btn.listening {
    background: linear-gradient(145deg, #d32f2f, #b71c1c);
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  .voice-status {
    display: none;
    margin-top: 15px;
    padding: 12px 20px;
    background: var(--bg);
    border-radius: 12px;
    color: var(--primary);
    font-size: 0.9rem;
    box-shadow: 
      inset 3px 3px 8px var(--shadow-dark),
      inset -3px -3px 8px var(--shadow-light);
  }

  .filters-toggle {
    color: var(--primary);
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
  }

  .filters-toggle:hover {
    text-decoration: underline;
  }

  .filters-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
    padding: 20px;
    background: var(--bg);
    border-radius: 15px;
    box-shadow: 
      inset 4px 4px 10px var(--shadow-dark),
      inset -4px -4px 10px var(--shadow-light);
  }

  .filter-group label {
    display: block;
    margin-bottom: 8px;
    color: var(--text);
    font-weight: 500;
    font-size: 0.9rem;
  }

  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
  }

  .results-header h3 {
    color: var(--text);
    font-size: 1.3rem;
  }

  .results-count {
    background: var(--bg);
    padding: 8px 16px;
    border-radius: 20px;
    color: var(--primary);
    font-weight: 500;
    box-shadow: 
      3px 3px 8px var(--shadow-dark),
      -3px -3px 8px var(--shadow-light);
  }

  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 25px;
  }

  .fruit-card {
    background: var(--bg);
    border-radius: 20px;
    padding: 20px;
    text-decoration: none;
    box-shadow: 
      8px 8px 20px var(--shadow-dark),
      -8px -8px 20px var(--shadow-light);
    transition: all 0.3s ease;
  }

  .fruit-card:hover {
    transform: translateY(-8px);
    box-shadow: 
      12px 12px 30px var(--shadow-dark),
      -12px -12px 30px var(--shadow-light);
  }

  .fruit-card img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 15px;
    margin-bottom: 15px;
  }

  .fruit-card .name {
    color: var(--text);
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 8px;
  }

  .fruit-card .origin {
    color: var(--text-light);
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .fruit-card .score {
    color: var(--primary);
    font-size: 0.8rem;
    margin-top: 8px;
    font-style: italic;
  }

  .no-results {
    text-align: center;
    padding: 50px;
    color: var(--text-light);
  }

  .no-results-icon {
    font-size: 4rem;
    margin-bottom: 20px;
  }

  .messages {
    list-style: none;
    margin-bottom: 20px;
  }

  .messages li {
    background: #ffebee;
    color: #c62828;
    padding: 12px 20px;
    border-radius: 10px;
    margin-bottom: 10px;
  }
</style>

<div class="search-header">
  <h2>T√¨m ki·∫øm tr√°i c√¢y</h2>
  <p>Nh·∫≠p t√™n, m√¥ t·∫£ ho·∫∑c ƒë·∫∑c ƒëi·ªÉm c·ªßa tr√°i c√¢y b·∫°n mu·ªën t√¨m</p>
</div>

<form action="{{ url_for('search_text') }}" method="POST" id="searchForm">
  <div class="search-box">
    <div class="search-main">
      <div class="search-input-wrapper">
        <input type="text" name="keyword" id="keywordInput" class="neu-input" style="width: 100%;"
               placeholder="V√≠ d·ª•: tr√°i c√¢y ng·ªçt, m√†u v√†ng, mi·ªÅn T√¢y..." 
               value="{{ keyword|default('') }}">
        <button type="button" id="voiceBtn" class="voice-btn" title="T√¨m b·∫±ng gi·ªçng n√≥i">Mic</button>
      </div>
      <button type="submit" class="neu-btn neu-btn-primary">T√¨m ki·∫øm</button>
    </div>
    
    <div id="voiceStatus" class="voice-status">
      üéôÔ∏è ƒêang nghe... H√£y n√≥i t√™n tr√°i c√¢y!
    </div>

    <details>
      <summary class="filters-toggle">B·ªô l·ªçc n√¢ng cao</summary>
      <div class="filters-content">
        <div class="filter-group">
          <label>M√†u s·∫Øc</label>
          <select name="color" class="neu-select" style="width: 100%;">
            <option value="">T·∫•t c·∫£</option>
            {% for color in filter_options.colors|default([]) %}
            <option value="{{ color }}" {% if selected_color == color %}selected{% endif %}>{{ color }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="filter-group">
          <label>M√πa v·ª•</label>
          <select name="season" class="neu-select" style="width: 100%;">
            <option value="">T·∫•t c·∫£</option>
            {% for season in filter_options.seasons|default([]) %}
            <option value="{{ season }}" {% if selected_season == season %}selected{% endif %}>{{ season }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="filter-group">
          <label>Ngu·ªìn g·ªëc</label>
          <select name="origin" class="neu-select" style="width: 100%;">
            <option value="">T·∫•t c·∫£</option>
            {% for origin in filter_options.origins|default([]) %}
            <option value="{{ origin }}" {% if selected_origin == origin %}selected{% endif %}>{{ origin }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </details>
  </div>
</form>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

{% if results %}
  <div class="results-header">
    <h3>K·∫øt qu·∫£ t√¨m ki·∫øm</h3>
    <span class="results-count">{{ results|length }} tr√°i c√¢y</span>
  </div>
  
  <div class="results-grid">
    {% for item in results %}
      <a href="/fruit/{{ item.payload.name }}" class="fruit-card">
        <img src="{{ item.payload.image_url }}" alt="{{ item.payload.name }}">
        <div class="name">{{ item.payload.name }}</div>
        {% if item.payload.origin %}
          <div class="origin">{{ item.payload.origin }}</div>
        {% endif %}
        {% if item.score and item.score < 1 %}
          <div class="score">ƒê·ªô t∆∞∆°ng ƒë·ªìng: {{ (item.score * 100)|round(1) }}%</div>
        {% endif %}
      </a>
    {% endfor %}
  </div>
{% elif keyword or selected_color or selected_season or selected_origin %}
  <div class="no-results">
    <div class="no-results-icon">üçÉ</div>
    <p>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p</p>
  </div>
{% else %}
  <div class="no-results">
    <div class="no-results-icon">üîç</div>
    <p>Nh·∫≠p t·ª´ kh√≥a ho·∫∑c ch·ªçn b·ªô l·ªçc ƒë·ªÉ b·∫Øt ƒë·∫ßu t√¨m ki·∫øm</p>
  </div>
{% endif %}

<script>
const voiceBtn = document.getElementById('voiceBtn');
const keywordInput = document.getElementById('keywordInput');
const voiceStatus = document.getElementById('voiceStatus');
const searchForm = document.getElementById('searchForm');

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (SpeechRecognition) {
  const recognition = new SpeechRecognition();
  recognition.lang = 'vi-VN';
  recognition.continuous = false;
  recognition.interimResults = true;

  let isListening = false;

  voiceBtn.addEventListener('click', () => {
    if (isListening) {
      recognition.stop();
      return;
    }
    recognition.start();
  });

  recognition.onstart = () => {
    isListening = true;
    voiceBtn.classList.add('listening');
    voiceBtn.innerHTML = 'Stop';
    voiceStatus.style.display = 'block';
    voiceStatus.innerHTML = 'ƒêang nghe... H√£y n√≥i t√™n tr√°i c√¢y!';
  };

  recognition.onresult = (event) => {
    let transcript = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      transcript += event.results[i][0].transcript;
    }
    keywordInput.value = transcript;
    voiceStatus.innerHTML = 'ƒê√£ nh·∫≠n: "' + transcript + '"';
    
    if (event.results[event.results.length - 1].isFinal) {
      setTimeout(() => searchForm.submit(), 500);
    }
  };

  recognition.onerror = (event) => {
    voiceStatus.innerHTML = 'L·ªói: ' + (event.error === 'no-speech' ? 'Kh√¥ng nghe th·∫•y gi·ªçng n√≥i' : event.error);
  };

  recognition.onend = () => {
    isListening = false;
    voiceBtn.classList.remove('listening');
    voiceBtn.innerHTML = 'Mic';
    setTimeout(() => voiceStatus.style.display = 'none', 2000);
  };
} else {
  voiceBtn.style.display = 'none';
}
</script>
{% endblock %}
